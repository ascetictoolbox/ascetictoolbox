#!/bin/bash

  #---------------------------------------------------------------------------------------------------------------------
  # Functions
  #---------------------------------------------------------------------------------------------------------------------
  usage() {
    echo "***********************************************************"
    echo "  Usage: main"
    echo "***********************************************************"
  }

  display_error() {
    local errMsg=$1
    echo " "
    echo "ERROR: $errMsg"
    echo " "
  }



  #---------------------------------------------------------------------------------------------------------------------
  # MAIN PROGRAM
  #---------------------------------------------------------------------------------------------------------------------
  #Define script variables
  script_dir=$(pwd)/$(dirname $0)

  #Define user variables
  log_base_folder=${script_dir}/logs/                                  #Folder to store logs
  package_base_folder=${script_dir}/../builders/packages/              #Folder to store packages and upload them to repository
  declare -a distributions_name=('ubuntu' 'suse' 'centos' 'debian')
  declare -a distributions_pid=('' '' '' '')


  #---------------------------------------------------------------------------------------------------------------------
  # WARNING: DO NOT MODIFY ANYTHING BELOW THIS MESSAGE UNLESS YOU KNOW WHAT YOU ARE DOING
  #---------------------------------------------------------------------------------------------------------------------
  #Check no parameters
  if [[ "$#" -ne 0 ]]; then
     display_error "Incorrect number of parameters"
     usage
     exit 1
  fi

  #---------------------------------------------------------------------------------------------------------------------
  #Package COMPSs SVN Revision
  ${script_dir}/package_compss_svn
  if [ $? -ne 0 ]; then
    display_error "Error Packaging COMPSs SVN Revision"
    exit 1
  fi

  #---------------------------------------------------------------------------------------------------------------------
  #Compile COMPSs SVN Revision
  ${script_dir}/compile_compss_svn
  if [ $? -ne 0 ]; then
    display_error "Error Compiling COMPSs SVN Revision"
    exit 1
  fi

  #---------------------------------------------------------------------------------------------------------------------
  #Compile and prepare tests structure
  ${script_dir}/prepare_tests
  if [ $? -ne 0 ]; then
    display_error "Error Preparing Tests"
    exit 1
  fi

  #---------------------------------------------------------------------------------------------------------------------
  #Execute process in all distributions
  i=0
  while [ $i -lt ${#distributions_name[@]} ]; do
     distr=${distributions_name[$i]}
     echo -e "\e[0m"
     echo "********************************"
     echo "*** Start process on ${distr}  ***"
     echo "********************************"
     echo -e "\e[0m"
     #Wipe and create log folder
     rm -rf ${log_base_folder}/${distr}
     mkdir -p ${log_base_folder}/${distr}
     #Execute distribution process
     ${script_dir}/exec_distribution ${distr} ${log_base_folder}/${distr} ${package_base_folder} > ${log_base_folder}/${distr}/full_exec.log &
     distributions_pid[$i]=$!
     i=$((i+1))
  done

  #Waiting all tasks to finish
  echo " "
  echo "--- Main program is waiting all executions to finish @1h..."
  echo " "
  errorStatus=0
  i=0
  while [ $i -lt ${#distributions_name[@]} ]; do
     distr=${distributions_name[$i]}
     pid=${distributions_pid[$i]}
     wait $pid || let "errorStatus+=1"

     echo -e "\e[0m"
     echo "**********************************"
     echo "*** FULL EXECUTION LOG: ${distr}  ***"
     echo "**********************************"
     echo -e "\e[0m"
     cat ${log_base_folder}/${distr}/full_exec.log
     i=$((i+1))
  done

  if [ $errorStatus -ne 0 ]; then
      display_error "A distribution process failed. Please check errors above"
      exit 1
  fi

  #---------------------------------------------------------------------------------------------------------------------
  #End value
  echo " "
  echo " SUCCESS!"
  echo " "
  exit 0

